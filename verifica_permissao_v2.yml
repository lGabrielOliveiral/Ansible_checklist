- name: Verificar usuários e permissões no Postgres (usando .pgpass)
  hosts: localhost
  gather_facts: no

  vars:
    db:
      host: "pg-db1"
      port: 5432
      name: "postgres"
      user: "postgres"
    role_powertuning: "powertuning"
    user_monitoramento: "pgwatch2"
    users_consutores:
      - "powertuning"
      - "pgwatch2"

  module_defaults:
    community.postgresql.postgresql_query:
      login_host: "{{ db.host }}"
      login_port: "{{ db.port }}"
      login_db: "{{ db.name }}"
      login_user: "{{ db.user }}"

  tasks:
    - name: Checa conection
      include_tasks: "./tasks/db_connection_teste.yml"

    - name: "[role powertuning] tem login?"
      include_tasks: "./tasks/role_existe.yml"
      vars:
        user_to_check: "{{ role_powertuning }}"

    #    - name: "[role powertuning] tem pgmonitor?"
    #      include_tasks: "./tasks/role_tem_pgmonitor.yml"
    #      vars:
    #        user_to_check: "{ { role_powertuning } }"

    - name: Resultado - powertuning
      ansible.builtin.debug:
        msg:
          - "Exists ? =  {{ user_checks.get(role_powertuning, {}).exists | default(false) }}"
#          - "Existe? {{ (pt_exists.rowcount|int > 0) | ternary('SIM','NÃO') }}"
#          - "Tem pgmonitor?: {{ ((pt_pgmonitor.query_result|default([{'is_member': false}]))[0].is_member | default(false)) | ternary('SIM','NÃO') }}"
#          - "CREATEROLE?: {{ ((pt_createrole.query_result|default([{'rolcreaterole': false}]))[0].rolcreaterole | default(false)) | ternary('SIM','NÃO') }}"
#          - "LOGIN?: {{ ((pt_login.query_result|default([{'rolcanlogin': false}]))[0].rolcanlogin | default(false)) | ternary('SIM','NÃO') }}"
